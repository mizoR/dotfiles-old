#!/bin/bash

DOTFILES_PATH=$(cd "$(dirname $0)/..";pwd)

COLOR_ERROR="echo -en \\033[1;31;1m"
COLOR_WARN="echo -en \\033[1;35;1m"
COLOR_INFO="echo -en \\033[1;32m"
COLOR_DEBUG="echo -en \\033[1;34m"
COLOR_NORMAL="echo -en \\033[0;39m"

LOGLEVEL_ERROR=3
LOGLEVEL_WARN=2
LOGLEVEL_INFO=1
LOGLEVEL_DEBUG=0

LOGLEVEL=$LOGLEVEL_DEBUG

error() {
  if [ $LOGLEVEL -le $LOGLEVEL_ERROR ]; then
    $COLOR_ERROR
    echo "[E `date`] $@"
    $COLOR_NORMAL
  fi
}

warn() {
  if [ $LOGLEVEL -le $LOGLEVEL_WARN ]; then
    $COLOR_WARN
    echo "[W `date`] $@"
    $COLOR_NORMAL
  fi
}

info() {
  if [ $LOGLEVEL -le $LOGLEVEL_INFO ]; then
    $COLOR_INFO
    echo "[I `date`] $@"
    $COLOR_NORMAL
  fi
}

debug() {
  if [ $LOGLEVEL -le $LOGLEVEL_DEBUG ]; then
    $COLOR_DEBUG
    echo "[D `date`] $@"
    $COLOR_NORMAL
  fi
}

run() {
  debug $@
  if [ $LOGLEVEL -eq $LOGLEVEL_DEBUG ]; then
    $@
  else
    $@ >/dev/null
  fi
}

init() {
  (
    run cd $DOTFILES_PATH
    run git submodule init
    run git submodule update
    run mkdir -p $DOTFILES_PATH/dot.rbenv/plugins
    if [ ! -d $DOTFILES_PATH/dot.rbenv/plugins/ruby-build ]; then
      run git clone git@github.com:sstephenson/ruby-build.git $DOTFILES_PATH/dot.rbenv/plugins/ruby-build
    fi
  )
}

install_zsh() {
  info Installing zsh dotfiles...

  if [ ! -L $HOME/.oh-my-zsh ]; then
    run ln -s $DOTFILES_PATH/dot.oh-my-zsh $HOME/.oh-my-zsh
  fi

  if [ ! -L $HOME/.zshrc ]; then
    run ln -s $DOTFILES_PATH/dot.zshrc $HOME/.zshrc
  fi

  if [ ! -L $HOME/.zprofile ]; then
    run ln -s $DOTFILES_PATH/dot.zprofile $HOME/.zprofile
  fi

  info Finished.
}

install_vim() {
  info Installing vim dotfiles...

  if [ ! -L $HOME/.vim ]; then
    run ln -s $DOTFILES_PATH/dot.vim $HOME/.vim
  fi

  if [ ! -L $HOME/.vimrc ]; then
    run ln -s $DOTFILES_PATH/dot.vimrc $HOME/.vimrc
  fi

  run vim -c NeoBundleInstall -c "q!"

  info Finished.
}

install_tmux() {
  info Installing tmux dotfiles...

  if [ ! -L $HOME/.tmux.conf ]; then
    run ln -s $DOTFILES_PATH/dot.tmux.conf $HOME/.tmux.conf
  fi

  info Finished.
}

install_rbenv() {
  info Installing rbenv dotfiles...

  if [ ! -L $HOME/.rbenv ]; then
    run ln -s $DOTFILES_PATH/dot.rbenv $HOME/.rbenv
  fi

  info Finished.
}

install_git() {
  info Installing git dotfiles...

  if [ ! -L $HOME/.gitignore ]; then
    run ln -s $DOTFILES_PATH/dot.gitignore $HOME/.gitignore
  fi

  info Finished.
}

update() {
  info Updating dotfiles...

  (
    run cd $DOTFILES_PATH
    run git pull origin `git symbolic-ref --short HEAD`
    run git submodule foreach 'git pull origin master'
    run git submodule update
  )

  info Finished.
}

case "$1" in
  install)
    init
    install_zsh
    install_vim
    install_tmux
    install_rbenv
    install_git
    ;;
  update)
    update
    ;;
  *)
    $COLOR_WARN
    echo "Unknow option: $@"
    $COLOR_INFO
    echo "usage: ~/dotfiles/bin/dotfiles [install|update]"
    $COLOR_NORMAL
    ;;
esac

exit 0

